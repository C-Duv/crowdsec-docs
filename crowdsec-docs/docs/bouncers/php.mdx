---
id: php
title: PHP Bouncer
sidebar_position: 1
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import useBaseUrl from '@docusaurus/useBaseUrl';

<p align="center">
<img src={useBaseUrl('/img/crowdsec_bouncer_php.png')} alt="CrowdSec" title="CrowdSec" width="300" height="300" />
</p>

<p align="center">
&#x1F4DA; <a href="#installation/">Documentation</a>
&#x1F4A0; <a href="https://hub.crowdsec.net">Hub</a>
&#128172; <a href="https://discourse.crowdsec.net">Discourse </a>
</p>


# What is it ?

This bouncer allows to protect your php application from IPs that have been detected by crowdsec. Based on the decision that crowdsec holds, they will either get denied (403) or have to fill a captcha.

This bouncer uses the PHP `auto_prepend_file` mechanism and the [crowdsec php library](https://github.com/crowdsecurity/php-cs-bouncer) to offer bouncer/IPS capability directly in your php application.
The bouncer supports remediations "ban" and "captcha", and both IP/Range decisions and geoloc decisions.

# Scope of this documentation

This documentation only covers setup of the library in `auto_prepend_file` mode. The library itself has more detailed documentation :
 - [Library homepage](https://github.com/crowdsecurity/php-cs-bouncer)
 - [Library user guide](https://github.com/crowdsecurity/php-cs-bouncer/blob/main/docs/USER_GUIDE.md)
 - [Library installation guide](https://github.com/crowdsecurity/php-cs-bouncer/blob/main/docs/INSTALLATION_GUIDE.md)
 - [Technical notes](https://github.com/crowdsecurity/php-cs-bouncer/blob/main/docs/TECHNICAL_NOTES.md) and [Developer documentation](https://github.com/crowdsecurity/php-cs-bouncer/blob/main/docs/DEVELOPER.md) 

# Installation

## Prerequisites

 - This is a php library, so you must have a working PHP (>= 7.2) installation.
 - Requires php extensions : ext-curl, ext-gd
 - Dependencies are dealt with via `composer`
 - Download the latest release of the bouncer [here](https://github.com/crowdsecurity/cs-php-bouncer/releases)
 - Have crowdsec on the same machine, or at least be able to reach LAPI

## Manual Installation

You can manually install the library and configure it with `auto_prepend_file` mechanism :
 - [library manual installation](https://github.com/crowdsecurity/php-cs-bouncer/blob/main/docs/INSTALLATION_GUIDE.md)

## Installation with helper script (apache only)

Alternatively, you can use the `install.sh` script to automate the setup on apache :

```bash
./install.sh --apache
```

The script will instruct you, after installation, to :
 - Set the owner of '/usr/local/php/crowdsec/' to www-data or similar : `sudo chown www-data /usr/local/php/crowdsec/`
 - Reload apache2 service : `sudo systemctl reload apache2`

:::note

If crowdsec/cscli is installed on your machine, the installer will take care of generating API key for you.
Otherwise, be sure to set `api_key` and `api_url`.

:::

## Upgrade with helper script

Clone the Github repository and run the upgrade script:

```bash
./upgrade.sh
```

:::note

Don't run the script as root but your password might be asked during the installation process.

:::

# Configuration

The bouncer configuration is located in `/usr/local/php/crowdsec/settings.php`.

Below are the most relevant options :

##### LAPI Connection

- `api_key`: Key generated by the cscli (CrowdSec cli) command like `cscli bouncers add bouncer-php-library`

- `api_url`: Define the URL to your LAPI server, default to `http://localhost:8080`.

- `api_timeout`: In seconds. The timeout when calling LAPI. Must be greater or equal than 1. Defaults to 1 sec.
- `api_user_agent`: HTTP user agent used to call CLAPI. Default to this library name/current version.

##### Debug
- `debug_mode`:true to enable verbose debug log.


- `log_directory_path`: Absolute path to store log files. Important note: be sur this path won't be publicly accessible

- `display_errors`: true to stop the process and display errors on browser if any.

- `forced_test_ip`: Only for test or debug purpose. Default to empty. If not empty, it will be used for all remediation and geolocation processes.
##### Bouncer behavior

- `bouncing_level`:  Select from `bouncing_disabled`, `normal_bouncing` or `flex_bouncing`. Choose if you want to apply CrowdSec directives (Normal bouncing) or be more permissive (Flex bouncing). With the `Flex mode`, it is impossible to accidentally block access to your site to people who don’t deserve it. This mode makes it possible to never ban an IP but only to offer a Captcha, in the worst-case scenario.

- `fallback_remediation`: Select from `bypass` (minimum remediation), `captcha` or `ban` (maximum remediation). Default to 'captcha'. Handle unknown remediations as.

- `max_remediation_level`: Select from `bypass`,`captcha` or `ban`. Default to 'ban'. Cap the 
  remediation to the selected one.

- `trust_ip_forward_array`:  If you use a CDN, a reverse proxy or a load balancer, set an array of IPs. For other IPs, the bouncer will not trust the X-Forwarded-For header.

- `excluded_uris`: array of URIs that will not be bounced

##### Cache

- `cache_system`: Select from `phpfs` (File system cache), `redis` or `memcached`.

- `fs_cache_path`: Will be used only if you choose File system as cache_system. Important note: be sur this path 
  won't be publicly accessible.

- `redis_dsn`:   Will be used only if you choose Redis cache as cache_system

- `memcached_dsn`: Will be used only if you choose Memcached as cache_system

- `clean_ip_cache_duration`: Set the duration we keep in cache the fact that an IP is clean. In seconds. Defaults to 5.

- `bad_ip_cache_duration`: Set the duration we keep in cache the fact that an IP is bad. In seconds. Defaults to 20.

- `stream_mode`: true to enable stream mode, false to enable the live mode. Default to false. By default, the `live mode` is enabled. The first time a stranger connects to your website, this mode means that the IP will be checked directly by the CrowdSec API. The rest of your user’s browsing will be even more transparent thanks to the fully customizable cache system. But you can also activate the `stream mode`. This mode allows you to constantly feed the bouncer with the malicious IP list via a background task (CRON), making it to be even faster when checking the IP of your visitors. Besides, if your site has a lot of unique visitors at the same time, this will not influence the traffic to the API of your CrowdSec instance.

##### Geolocation

- `geolocation`: Settings for geolocation remediation (i.e. country based remediation).
- `geolocation[enabled]`: true to enable remediation based on country. Default to false.
- `geolocation[type]`:  Geolocation system. Only 'maxmind' is available for the moment. Default to `maxmind`
  
- `geolocation[save_in_session]`: true to store the geolocalized country in session. Default to true. Setting true 
  will avoid multiple call to the geolocalized system (e.g. maxmind database)
- `geolocation[maxmind]`: MaxMind settings
- `geolocation[maxmind][database_type]`: Select from `country` or `city`. Default to `country`. These are the two available MaxMind database types.
- `geolocation[maxmind][database_path]`: Absolute path to the MaxMind database (mmdb 


##### Captcha and ban wall settings

- `hide_mentions`: true to hide CrowdSec mentions on ban and captcha walls.
- Wording and css settings: 

  `theme_color_text_primary`

  `theme_color_text_secondary`

  `theme_color_text_button`

  `theme_color_text_error_message`

  `theme_color_background_page`

  `theme_color_background_container`

  `theme_color_background_button`

  `theme_color_background_button_hover`

  `theme_custom_css`

  `theme_text_captcha_wall_tab_title`

  `theme_text_captcha_wall_title`

  `theme_text_captcha_wall_subtitle`

  `theme_text_captcha_wall_refresh_image_link`

  `theme_text_captcha_wall_captcha_placeholder`

  `theme_text_captcha_wall_send_button`

  `theme_text_captcha_wall_error_message`

  `theme_text_captcha_wall_footer`

  `theme_text_ban_wall_tab_title`

  `theme_text_ban_wall_title`

  `theme_text_ban_wall_subtitle`

  `theme_text_ban_wall_footer`


<details>
<summary>View full configuration</summary>


```php title=/usr/local/php/crowdsec/settings.php
<?php
// @see ../../docs/USER_GUIDE.md for possible settings details
use CrowdSecBouncer\Constants;

$crowdSecStandaloneBouncerConfig = [
    /** The bouncer api key to access LAPI.
     *
     * Key generated by the cscli (CrowdSec cli) command like "cscli bouncers add bouncer-php-library"
     */
    'api_key' => 'YOUR_BOUNCER_API_KEY',

    /** Define the URL to your LAPI server, default to http://localhost:8080.
     *
     * If you have installed the CrowdSec agent on your server, it should be "http://localhost:8080"
     */
    'api_url'=> Constants::DEFAULT_LAPI_URL,

    // In seconds. The timeout when calling LAPI. Must be greater or equal than 1. Defaults to 1 sec.
    'api_timeout'=> 1,

    // HTTP user agent used to call LAPI. Default to this library name/current version.
    'api_user_agent'=> 'CrowdSec PHP Library/x.x.x',

    // true to enable verbose debug log.
    'debug_mode' => false,

    /** Absolute path to store log files.
     *
     * Important note: be sur this path won't be publicly accessible
     */
    'log_directory_path' => __DIR__.'/.logs',

    // true to stop the process and display errors if any.
    'display_errors' => false,

    /** Only for test or debug purpose. Default to empty.
     *
     * If not empty, it will be used for all remediation and geolocation processes.
     */
    'forced_test_ip' => '',

    /** Select from 'bouncing_disabled', 'normal_bouncing' or 'flex_bouncing'.
     *
     * Choose if you want to apply CrowdSec directives (Normal bouncing) or be more permissive (Flex bouncing).
     * With the `Flex mode`, it is impossible to accidentally block access to your site to people who don’t
     * deserve it. This mode makes it possible to never ban an IP but only to offer a Captcha, in the worst-case
     * scenario.
     */
    'bouncing_level' => Constants::BOUNCING_LEVEL_NORMAL,

    /** Select from 'bypass' (minimum remediation), 'captcha' or 'ban' (maximum remediation).
     * Default to 'captcha'.
     *
     * Handle unknown remediations as.
     */
    'fallback_remediation'=> Constants::REMEDIATION_CAPTCHA,

    /** Select from 'bypass' (minimum remediation),'captcha' or 'ban' (maximum remediation).
     * Default to 'ban'.
     *
     * Cap the remediation to the selected one.
     */
    'max_remediation_level'=> Constants::REMEDIATION_BAN,

    /** If you use a CDN, a reverse proxy or a load balancer, set an array of IPs.
     *
     * For other IPs, the bouncer will not trust the X-Forwarded-For header.
     */
    'trust_ip_forward_array' => [],

    /**
     * array of URIs that will not be bounced
     */
    'excluded_uris' => ['/favicon.ico'],

    // Select from 'phpfs' (File system cache), 'redis' or 'memcached'.
    'cache_system' => Constants::CACHE_SYSTEM_PHPFS,

    /** Will be used only if you choose File system as cache_system
     *
     * Important note: be sur this path won't be publicly accessible
     */
    'fs_cache_path' => __DIR__.'/.cache',

    // Will be used only if you choose Redis cache as cache_system
    'redis_dsn' => 'redis://localhost:6379',

    // Will be used only if you choose Memcached as cache_system
    'memcached_dsn' => 'memcached://localhost:11211',

    // Set the duration we keep in cache the fact that an IP is clean. In seconds. Defaults to 5.
    'clean_ip_cache_duration'=> Constants::CACHE_EXPIRATION_FOR_CLEAN_IP,

    // Optional. Set the duration we keep in cache the fact that an IP is bad. In seconds. Defaults to 20.
    'bad_ip_cache_duration'=> Constants::CACHE_EXPIRATION_FOR_BAD_IP,

    /** true to enable stream mode, false to enable the live mode. Default to false.
     *
     * By default, the `live mode` is enabled. The first time a stranger connects to your website, this mode
     * means that the IP will be checked directly by the CrowdSec API. The rest of your user’s browsing will be
     * even more transparent thanks to the fully customizable cache system.
     *
     * But you can also activate the `stream mode`. This mode allows you to constantly feed the bouncer with the
     * malicious IP list via a background task (CRON), making it to be even faster when checking the IP of your
     * visitors. Besides, if your site has a lot of unique visitors at the same time, this will not influence the
     * traffic to the API of your CrowdSec instance.
     */
    'stream_mode'=> false,

    // Settings for geolocation remediation (i.e. country based remediation).
    'geolocation' => [
        // true to enable remediation based on country. Default to false.
        'enabled' => false,
        // Geolocation system. Only 'maxmind' is available for the moment. Default to 'maxmind'
        'type' => Constants::GEOLOCATION_TYPE_MAXMIND,
        /** true to store the geolocalized country in session. Default to true.
         *
         * Setting true will avoid multiple call to the geolocalized system (e.g. maxmind database)
         */
        'save_in_session' => true,
        // MaxMind settings
        'maxmind' => [
            /**Select from 'country' or 'city'. Default to 'country'
             *
             * These are the two available MaxMind database types.
             */
            'database_type' => Constants::MAXMIND_COUNTRY,
            // Absolute path to the MaxMind database (mmdb file).
            'database_path' => '/some/path/GeoLite2-Country.mmdb',
        ]
    ],

    //true to hide CrowdSec mentions on ban and captcha walls.
    'hide_mentions' => false,

    // Settings for ban and captcha walls
    'theme_color_text_primary' => 'black',
    'theme_color_text_secondary' => '#AAA',
    'theme_color_text_button' => 'white',
    'theme_color_text_error_message' => '#b90000',
    'theme_color_background_page' => '#eee',
    'theme_color_background_container' => 'white',
    'theme_color_background_button' => '#626365',
    'theme_color_background_button_hover' => '#333',
    'theme_custom_css' => '',
    // Settings for captcha wall
    'theme_text_captcha_wall_tab_title' => 'Oops..',
    'theme_text_captcha_wall_title' => 'Hmm, sorry but...',
    'theme_text_captcha_wall_subtitle' => 'Please complete the security check.',
    'theme_text_captcha_wall_refresh_image_link' => 'refresh image',
    'theme_text_captcha_wall_captcha_placeholder' => 'Type here...',
    'theme_text_captcha_wall_send_button' => 'CONTINUE',
    'theme_text_captcha_wall_error_message' => 'Please try again.',
    'theme_text_captcha_wall_footer' => '',
    // Settings for ban wall
    'theme_text_ban_wall_tab_title' => 'Oops..',
    'theme_text_ban_wall_title' => '🤭 Oh!',
    'theme_text_ban_wall_subtitle' => 'This page is protected against cyber attacks and your IP has been banned by our system.',
    'theme_text_ban_wall_footer' => '',
];
```

</details>

# Testing & Troubleshooting

## Logs

Enable `debug_mode` in the library's config (`/usr/local/php/crowdsec/settings.php`) to enable non-error logging. Logs will be located in the library path, ie `/usr/local/php/crowdsec/.logs/`

## Testing base remediation

To test the base remediation :
 - identify or create simple php file (even a `<?php print("hello") ?>` would do)
 - add a decision on your crowdsec agent (`cscli decisions add -i <your ip>`)
 - try to access the php file, and you should see the HTML forbidden page

 ![php blocked page](/img/php-denied.png)

## Testing the captcha feature

To test the captcha remediation :
 - identify or create simple php file (even a `<?php print("hello") ?>` would do)
 - add a decision on your crowdsec agent (`cscli decisions add -i <your ip> -t captcha`)
 - try to access the php file, and you should see the captcha page

 ![php captcha page](/img/php-captcha.png)


## Testing geolocation remediation

The bouncer is expecting decisions with a scope of `Country`, and 2-letters code value.

To test the geoloc remediation :
 - identify or create simple php file (even a `<?php print("hello") ?>` would do)
 - add a decision on your crowdsec agent (`cscli decisions add --scope Country --value FR -t captcha`)
 - try to access the php file, and you should see the captcha page

## References

- https://crowdsec.net/protect-php-websites/
